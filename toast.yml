image: ubuntu
command_prefix: set -euxo pipefail
tasks:
  apt:
    command: |
      apt-get update
      apt-get install ruby-full build-essential zlib1g-dev curl git entr --yes
  tailwindcss:
    dependencies:
    - apt
    command: |
      cd /usr/local/bin
      curl -sLO https://github.com/tailwindlabs/tailwindcss/releases/download/v3.3.3/tailwindcss-linux-x64
      chmod +x tailwindcss-linux-x64
      mv tailwindcss-linux-x64 /usr/local/bin/tailwindcss
  ruby:
    dependencies:
    - apt
    command: |
      gem install jekyll bundler
  bundle:
    dependencies:
    - ruby
    input_paths:
    - Gemfile
    - Gemfile.lock
    command: |
      bundle install
  build:
    dependencies:
    - bundle
    - tailwindcss
    input_paths:
    - .
    output_paths:
    - _site/
    command: |
      tailwindcss -o assets/css/tailwind.css
      bundle exec jekyll build
  dev:
    cache: false
    dependencies:
    - bundle
    - tailwindcss
    mount_paths:
    - .
    ports:
    - 4000:4000
    environment:
      # https://github.com/eradman/entr/issues/3
      ENTR_INOTIFY_WORKAROUND: "1"
    command: |
      git ls-files | entr -n -c -r -s 'tailwindcss -o assets/css/tailwind.css && bundle exec jekyll serve --no-watch --host=0.0.0.0'
